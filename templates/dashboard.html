{% extends 'base.html' %}

{% block title %}Dashboard - CashFlow Pro{% endblock %}
{% block page_title %}Dashboard Overview{% endblock %}
{% block page_subtitle %}Analisis keuangan Anda secara real-time{% endblock %}

{% block content %}
<div class="space-y-8">
    <!-- Welcome Section -->
    <div class="glass-card p-8 hover-lift">
        <div class="flex flex-col lg:flex-row items-start lg:items-center justify-between gap-6">
            <div class="flex-1">
                <div class="flex items-center space-x-4 mb-4">
                    <div class="w-16 h-16 gradient-primary rounded-2xl flex items-center justify-center shadow-xl">
                        <i class="fas fa-wallet text-white text-2xl"></i>
                    </div>
                    <div>
                        <h1 class="text-3xl font-bold text-gray-900">Selamat Datang, {{ current_user.full_name or current_user.username }}! ðŸ‘‹</h1>
                        <p class="text-gray-600 mt-2">Pantau dan kelola keuangan Anda dengan mudah</p>
                    </div>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-6">
                    <div class="p-4 bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl">
                        <p class="text-sm font-medium text-blue-700">Total Transaksi</p>
                        <p class="text-2xl font-bold text-gray-900 mt-1">{{ totals.total_transactions }}</p>
                    </div>
                    <div class="p-4 bg-gradient-to-br from-green-50 to-green-100 rounded-xl">
                        <p class="text-sm font-medium text-green-700">Total Pemasukan</p>
                        <p class="text-2xl font-bold text-gray-900 mt-1">{{ format_rupiah(totals.total_income) }}</p>
                    </div>
                    <div class="p-4 bg-gradient-to-br from-red-50 to-red-100 rounded-xl">
                        <p class="text-sm font-medium text-red-700">Total Pengeluaran</p>
                        <p class="text-2xl font-bold text-gray-900 mt-1">{{ format_rupiah(totals.total_expense) }}</p>
                    </div>
                    <div class="p-4 bg-gradient-to-br from-purple-50 to-purple-100 rounded-xl">
                        <p class="text-sm font-medium text-purple-700">Net Balance</p>
                        <p class="text-2xl font-bold {% if totals.total_balance >= 0 %}text-green-600{% else %}text-red-600{% endif %} mt-1">
                            {{ format_rupiah(totals.total_balance) }}
                        </p>
                    </div>
                </div>
            </div>
            <div>
                <a href="{{ url_for('transactions') }}" class="btn-primary px-8 py-4 text-lg font-bold flex items-center">
                    <i class="fas fa-plus-circle mr-3 text-xl"></i>
                    Tambah Transaksi
                </a>
            </div>
        </div>
    </div>

    <!-- Balance Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <!-- Cash Balance -->
        <div class="stat-card glass-card hover-lift p-6" style="--color-start: #3b82f6; --color-end: #1d4ed8;">
            <div class="flex items-start justify-between mb-6">
                <div class="w-14 h-14 gradient-blue rounded-2xl flex items-center justify-center shadow-lg">
                    <i class="fas fa-money-bill-wave text-white text-2xl"></i>
                </div>
                <span class="text-xs font-bold px-3 py-1.5 rounded-full bg-blue-100 text-blue-700">
                    CASH
                </span>
            </div>
            <h3 class="text-3xl font-bold text-gray-900 mb-2">{{ format_rupiah(totals.cash_balance) }}</h3>
            <p class="text-gray-600 mb-4">Saldo Cash</p>
            <div class="space-y-2">
                <div class="flex justify-between items-center">
                    <span class="text-sm text-gray-500">Pemasukan</span>
                    <span class="text-sm font-bold text-green-600">+{{ format_rupiah(totals.cash_income) }}</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-sm text-gray-500">Pengeluaran</span>
                    <span class="text-sm font-bold text-red-600">-{{ format_rupiah(totals.cash_expense) }}</span>
                </div>
            </div>
        </div>
        
        <!-- Non-Cash Balance -->
        <div class="stat-card glass-card hover-lift p-6" style="--color-start: #8b5cf6; --color-end: #7c3aed;">
            <div class="flex items-start justify-between mb-6">
                <div class="w-14 h-14 gradient-purple rounded-2xl flex items-center justify-center shadow-lg">
                    <i class="fas fa-credit-card text-white text-2xl"></i>
                </div>
                <span class="text-xs font-bold px-3 py-1.5 rounded-full bg-purple-100 text-purple-700">
                    NON-CASH
                </span>
            </div>
            <h3 class="text-3xl font-bold text-gray-900 mb-2">{{ format_rupiah(totals.non_cash_balance) }}</h3>
            <p class="text-gray-600 mb-4">Saldo Non-Cash</p>
            <div class="space-y-2">
                <div class="flex justify-between items-center">
                    <span class="text-sm text-gray-500">Pemasukan</span>
                    <span class="text-sm font-bold text-green-600">+{{ format_rupiah(totals.non_cash_income) }}</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-sm text-gray-500">Pengeluaran</span>
                    <span class="text-sm font-bold text-red-600">-{{ format_rupiah(totals.non_cash_expense) }}</span>
                </div>
            </div>
        </div>
        
        <!-- Total Income -->
        <div class="stat-card glass-card hover-lift p-6" style="--color-start: #10b981; --color-end: #059669;">
            <div class="flex items-start justify-between mb-6">
                <div class="w-14 h-14 gradient-success rounded-2xl flex items-center justify-center shadow-lg">
                    <i class="fas fa-arrow-down text-white text-2xl"></i>
                </div>
                <span class="text-xs font-bold px-3 py-1.5 rounded-full bg-green-100 text-green-700">
                    INCOME
                </span>
            </div>
            <h3 class="text-3xl font-bold text-gray-900 mb-2">{{ format_rupiah(totals.total_income) }}</h3>
            <p class="text-gray-600 mb-4">Total Pemasukan</p>
            <div class="space-y-2">
                <div class="flex justify-between items-center">
                    <span class="text-sm text-gray-500">Cash</span>
                    <span class="text-sm font-bold text-blue-600">{{ format_rupiah(totals.cash_income) }}</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-sm text-gray-500">Non-Cash</span>
                    <span class="text-sm font-bold text-purple-600">{{ format_rupiah(totals.non_cash_income) }}</span>
                </div>
            </div>
        </div>
        
        <!-- Total Expense -->
        <div class="stat-card glass-card hover-lift p-6" style="--color-start: #ef4444; --color-end: #dc2626;">
            <div class="flex items-start justify-between mb-6">
                <div class="w-14 h-14 gradient-danger rounded-2xl flex items-center justify-center shadow-lg">
                    <i class="fas fa-arrow-up text-white text-2xl"></i>
                </div>
                <span class="text-xs font-bold px-3 py-1.5 rounded-full bg-red-100 text-red-700">
                    EXPENSE
                </span>
            </div>
            <h3 class="text-3xl font-bold text-gray-900 mb-2">{{ format_rupiah(totals.total_expense) }}</h3>
            <p class="text-gray-600 mb-4">Total Pengeluaran</p>
            <div class="space-y-2">
                <div class="flex justify-between items-center">
                    <span class="text-sm text-gray-500">Cash</span>
                    <span class="text-sm font-bold text-blue-600">{{ format_rupiah(totals.cash_expense) }}</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-sm text-gray-500">Non-Cash</span>
                    <span class="text-sm font-bold text-purple-600">{{ format_rupiah(totals.non_cash_expense) }}</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Income vs Expense Chart -->
        <div class="glass-card p-6 hover-lift">
            <div class="flex justify-between items-center mb-8">
                <div>
                    <h3 class="text-xl font-bold text-gray-900">Cash Flow 30 Hari</h3>
                    <p class="text-gray-600">Pemasukan vs Pengeluaran</p>
                </div>
                <span class="text-xs font-bold px-3 py-1.5 rounded-full bg-blue-100 text-blue-700">
                    <i class="fas fa-chart-line mr-2"></i> LIVE
                </span>
            </div>
            <div class="chart-container">
                <canvas id="cashFlowChart"></canvas>
            </div>
            <div class="flex justify-center space-x-8 mt-6">
                <div class="flex items-center">
                    <div class="w-3 h-3 rounded-full bg-green-500 mr-2"></div>
                    <span class="text-sm text-gray-600">Pemasukan</span>
                </div>
                <div class="flex items-center">
                    <div class="w-3 h-3 rounded-full bg-red-500 mr-2"></div>
                    <span class="text-sm text-gray-600">Pengeluaran</span>
                </div>
                <div class="flex items-center">
                    <div class="w-3 h-3 rounded-full bg-blue-500 mr-2"></div>
                    <span class="text-sm text-gray-600">Saldo</span>
                </div>
            </div>
        </div>
        
        <!-- Category Distribution -->
        <div class="glass-card p-6 hover-lift">
            <div class="flex justify-between items-center mb-8">
                <div>
                    <h3 class="text-xl font-bold text-gray-900">Distribusi Kategori</h3>
                    <p class="text-gray-600">Komposisi transaksi keuangan</p>
                </div>
                <span class="text-xs font-bold px-3 py-1.5 rounded-full bg-purple-100 text-purple-700">
                    <i class="fas fa-percentage mr-2"></i> PERCENTAGE
                </span>
            </div>
            <div class="chart-container">
                <canvas id="categoryChart"></canvas>
            </div>
            <div class="grid grid-cols-2 gap-3 mt-6">
                {% for label, value, color in zip(chart_data.category_labels, chart_data.category_values, chart_data.category_colors) %}
                <div class="flex items-center justify-between p-3 bg-gray-50/50 rounded-xl">
                    <div class="flex items-center">
                        <div class="w-3 h-3 rounded-full mr-3" style="background-color: {{ color }}"></div>
                        <span class="text-sm font-medium text-gray-700">{{ label }}</span>
                    </div>
                    <span class="text-sm font-bold text-gray-900">{{ format_rupiah(value) }}</span>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Recent Transactions & Monthly Summary -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Recent Transactions -->
        <div class="glass-card p-6 hover-lift">
            <div class="flex justify-between items-center mb-8">
                <h3 class="text-xl font-bold text-gray-900">Transaksi Terbaru</h3>
                <a href="{{ url_for('transactions') }}" class="text-blue-600 hover:text-blue-800 font-semibold text-sm flex items-center">
                    Lihat Semua <i class="fas fa-arrow-right ml-2"></i>
                </a>
            </div>
            
            {% if recent_transactions and recent_transactions|length > 0 %}
            <div class="space-y-4">
                {% for r in recent_transactions %}
                <div class="transaction-item p-4 bg-gradient-to-r from-gray-50 to-gray-100/50 rounded-2xl border border-gray-200/50">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <div class="w-12 h-12 rounded-xl flex items-center justify-center mr-4
                                {% if r.category == 'cash' %}gradient-blue text-white{% else %}gradient-purple text-white{% endif %}">
                                <i class="fas {% if r.category == 'cash' %}fa-money-bill-wave{% else %}fa-credit-card{% endif %}"></i>
                            </div>
                            <div>
                                <p class="font-bold text-gray-900">{{ r.description }}</p>
                                <p class="text-xs text-gray-500 mt-1">{{ r.display_date }}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-xl font-bold {% if r.transaction_type == 'income' %}text-green-600{% else %}text-red-600{% endif %}">
                                {{ ' +' if r.transaction_type == 'income' else ' -' }}{{ format_rupiah(r.amount) }}
                            </p>
                            <span class="text-xs font-bold px-3 py-1 rounded-full 
                                {% if r.transaction_type == 'income' %}bg-green-100 text-green-800{% else %}bg-red-100 text-red-800{% endif %}">
                                {{ 'PEMASUKAN' if r.transaction_type == 'income' else 'PENGELUARAN' }}
                            </span>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-12">
                <div class="w-20 h-20 gradient-primary rounded-2xl flex items-center justify-center mx-auto mb-6">
                    <i class="fas fa-exchange-alt text-white text-2xl"></i>
                </div>
                <p class="text-gray-500 text-lg mb-4">Belum ada transaksi</p>
                <a href="{{ url_for('transactions') }}" class="btn-primary inline-flex items-center px-6 py-3">
                    <i class="fas fa-plus mr-3"></i> Tambah Transaksi Pertama
                </a>
            </div>
            {% endif %}
        </div>
        
        <!-- Monthly Summary -->
        <div class="glass-card p-6 hover-lift">
            <div class="flex justify-between items-center mb-8">
                <h3 class="text-xl font-bold text-gray-900">Ringkasan Bulanan</h3>
                <span class="text-xs font-bold px-3 py-1.5 rounded-full bg-green-100 text-green-700">
                    {{ current_year }}
                </span>
            </div>
            
            {% if monthly_summary and monthly_summary|length > 0 %}
            <div class="space-y-4">
                {% for month in monthly_summary %}
                <div class="flex items-center justify-between p-4 bg-gradient-to-r from-gray-50 to-gray-100/50 rounded-2xl hover:from-blue-50/50 hover:to-blue-100/50 transition-all duration-300">
                    <div class="flex items-center">
                        <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-blue-100 to-blue-200 flex items-center justify-center mr-4">
                            <span class="text-sm font-bold text-blue-700">{{ month.month[:3] }}</span>
                        </div>
                        <div>
                            <p class="font-bold text-gray-900">{{ month.month }}</p>
                            <div class="flex space-x-3 text-xs mt-1">
                                <span class="text-green-600 font-medium">+{{ format_rupiah(month.income) }}</span>
                                <span class="text-red-600 font-medium">-{{ format_rupiah(month.expense) }}</span>
                            </div>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="text-lg font-bold {% if month.balance >= 0 %}text-green-600{% else %}text-red-600{% endif %}">
                            {{ format_rupiah(month.balance) }}
                        </p>
                        <div class="text-xs text-gray-500 mt-1">
                            {{ ((month.balance/(month.income if month.income > 0 else 1))*100)|round(1) }}%
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            
            <div class="mt-8 pt-6 border-t border-gray-200/50">
                <div class="flex justify-between items-center">
                    <span class="font-bold text-gray-900">Rata-rata per bulan:</span>
                    <span class="text-xl font-bold text-blue-600">
                        {% set total_balance = monthly_summary|sum(attribute='balance') %}
                        {% set avg_balance = total_balance/monthly_summary|length if monthly_summary|length > 0 else 0 %}
                        {{ format_rupiah(avg_balance) }}
                    </span>
                </div>
            </div>
            {% else %}
            <div class="text-center py-12">
                <div class="w-20 h-20 gradient-primary rounded-2xl flex items-center justify-center mx-auto mb-6">
                    <i class="fas fa-calendar text-white text-2xl"></i>
                </div>
                <p class="text-gray-500 text-lg">Belum ada data bulanan</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
// Chart data
const chartData = {
    dates: {{ chart_data.dates|tojson }},
    incomeData: {{ chart_data.income_data|tojson }},
    expenseData: {{ chart_data.expense_data|tojson }},
    balances: {{ chart_data.balances|tojson }},
    categoryLabels: {{ chart_data.category_labels|tojson }},
    categoryValues: {{ chart_data.category_values|tojson }},
    categoryColors: {{ chart_data.category_colors|tojson }}
};

// Initialize charts
document.addEventListener('DOMContentLoaded', function() {
    // Cash Flow Chart
    const flowCtx = document.getElementById('cashFlowChart').getContext('2d');
    if (flowCtx) {
        new Chart(flowCtx, {
            type: 'line',
            data: {
                labels: chartData.dates,
                datasets: [
                    {
                        label: 'Pemasukan',
                        data: chartData.incomeData,
                        borderColor: '#10B981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.4,
                        fill: true,
                        borderWidth: 3
                    },
                    {
                        label: 'Pengeluaran',
                        data: chartData.expenseData,
                        borderColor: '#EF4444',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        tension: 0.4,
                        fill: true,
                        borderWidth: 3
                    },
                    {
                        label: 'Saldo',
                        data: chartData.balances,
                        borderColor: '#3B82F6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4,
                        fill: false,
                        borderWidth: 3,
                        borderDash: [5, 5]
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        backgroundColor: 'rgba(255, 255, 255, 0.9)',
                        titleColor: '#1F2937',
                        bodyColor: '#4B5563',
                        borderColor: '#E5E7EB',
                        borderWidth: 1,
                        callbacks: {
                            label: function(context) {
                                return `${context.dataset.label}: Rp ${context.parsed.y.toLocaleString('id-ID')}`;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        grid: {
                            display: false
                        },
                        ticks: {
                            color: '#6B7280'
                        }
                    },
                    y: {
                        beginAtZero: true,
                        grid: {
                            borderDash: [5, 5]
                        },
                        ticks: {
                            color: '#6B7280',
                            callback: function(value) {
                                if (value >= 1000000) {
                                    return 'Rp ' + (value/1000000).toFixed(1) + 'M';
                                } else if (value >= 1000) {
                                    return 'Rp ' + (value/1000).toFixed(0) + 'K';
                                }
                                return 'Rp ' + value;
                            }
                        }
                    }
                }
            }
        });
    }
    
    // Category Chart
    const catCtx = document.getElementById('categoryChart').getContext('2d');
    if (catCtx && chartData.categoryLabels.length > 0) {
        new Chart(catCtx, {
            type: 'doughnut',
            data: {
                labels: chartData.categoryLabels,
                datasets: [{
                    data: chartData.categoryValues,
                    backgroundColor: chartData.categoryColors,
                    borderWidth: 0,
                    borderRadius: 8,
                    spacing: 5
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '75%',
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: 'rgba(255, 255, 255, 0.9)',
                        titleColor: '#1F2937',
                        bodyColor: '#4B5563',
                        borderColor: '#E5E7EB',
                        borderWidth: 1,
                        callbacks: {
                            label: function(context) {
                                return `${context.label}: Rp ${context.parsed.toLocaleString('id-ID')}`;
                            }
                        }
                    }
                }
            }
        });
    }
});
</script>

<style>
/* Custom animations for dashboard */
@keyframes float {
    0%, 100% { transform: translateY(0px); }
    50% { transform: translateY(-10px); }
}

.animate-float {
    animation: float 3s ease-in-out infinite;
}

.stat-card {
    transition: all 0.3s ease;
}

.stat-card:hover {
    transform: translateY(-5px);
}

.chart-container canvas {
    border-radius: 12px;
}
</style>
{% endblock %}